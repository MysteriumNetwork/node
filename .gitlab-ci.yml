stages:
  - prepare
  - test
  - pre-release
  - build
  - release-snapshot
  - release-tag
  - post-release

variables:
  BUILD_COMMIT: $CI_COMMIT_SHORT_SHA
  BUILD_BRANCH: $CI_COMMIT_REF_NAME
  BUILD_BRANCH_SAFE: $CI_COMMIT_REF_SLUG
  BUILD_TAG: $CI_COMMIT_TAG
  BUILD_NUMBER: $CI_PIPELINE_ID
  GITHUB_OWNER: mysteriumnetwork
  GITHUB_REPO: node
  GITHUB_SNAPSHOT_REPO: node-builds

  GO_PACKAGE: github.com/mysteriumnetwork/node
  GIT_CLONE_PATH: /home/gitlab-runner/go/src/$GO_PACKAGE
  GOFLAGS: "-count=1" # Supersedes GOCACHE=off, see: https://github.com/golang/go/issues/29378#issuecomment-449383809

before_script:
  - GOPROXY=https://proxy.golang.org go mod download
  # load vars generated by prepare:env
  - source build/env.sh

after_script:
  # docker based jobs leave files owned by root
  - sudo chown -R gitlab-runner:gitlab-runner $GOPATH

env:
  stage: prepare
  tags: [go]
  artifacts:
    paths: [build/env.sh]
  script: go run mage.go -v GenerateEnvFile

checks:
  stage: test
  tags: [go]
  script:
    - |
      go get -u \
        golang.org/x/lint/golint \
        golang.org/x/tools/cmd/goimports \
        github.com/go-swagger/go-swagger/cmd/swagger
    - bin/check_golint
    - bin/check_goimports
    - bin/check_license
    - bin/check_govet
    - bin/check_swagger

test:
  stage: test
  tags: [go]
  script: go run mage.go -v Test

test-e2e-basic:
  stage: test
  tags: [go]
  script: go run mage.go -v TestE2EBasic

test-e2e-nat:
  stage: test
  tags: [go]
  script: go run mage.go -v TestE2ENAT

create-bucket:
  stage: pre-release
  tags: [go]
  script: go run mage.go -v MakeBucket

package:linux-amd64:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageLinuxAmd64

package:linux-arm:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageLinuxArm

package:linux-debian-amd64:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageLinuxDebianAmd64

package:linux-debian-arm:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageLinuxDebianArm

package:linux-raspberry-image:
  stage: build
  tags: [go,high_performance]
  script: go run mage.go -v PackageLinuxRaspberryImage

package:osx-amd64:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageOsxAmd64

package:windows-amd64:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageWindowsAmd64

package:ios:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageIOS

package:android:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageAndroid

package:docker-alpine:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageDockerAlpine

package:docker-ubuntu:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageDockerUbuntu

package:swagger-redoc-docker:
  stage: build
  tags: [go]
  script: go run mage.go -v PackageDockerSwaggerRedoc

release-snapshot:release:
  stage: release-snapshot
  tags: [go]
  script: go run mage.go -v ReleaseGithubSnapshot

release-snapshot:docker:
  stage: release-snapshot
  tags: [go]
  script: go run mage.go -v ReleaseDockerSnapshot

release-snapshot:debian-ppa:
  stage: release-snapshot
  tags: [go]
  script: go run mage.go -v ReleaseDebianPPASnapshot

release-snapshot:goreport:
  stage: release-snapshot
  tags: [go]
  script: bin/release_goreport
  only:
    - master

release-tag:release:
  stage: release-tag
  tags: [go]
  script: go run mage.go -v ReleaseGithubTag

release-tag:docker:
  stage: release-tag
  tags: [go]
  script: go run mage.go -v ReleaseDockerTag

release-tag:debian-ppa:
  stage: release-tag
  tags: [go]
  script: go run mage.go -v ReleaseDebianPPAPreRelease

release-tag:android-sdk:
  stage: release-tag
  tags: [go]
  script: go run mage.go -v ReleaseAndroidSDK

remove-bucket:
  stage: post-release
  tags: [go]
  script: go run mage.go -v RemoveBucket
  when: always

docker-prune:
  stage: post-release
  tags: [go]
  script: go run mage.go -v RemoveDanglingData
  when: always
